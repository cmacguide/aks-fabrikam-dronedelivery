# Solu√ß√£o para Erro AADSTS500208 - Entra ID External com AKS

<!-- Generated by Copilot -->

## ‚úÖ DIAGN√ìSTICO REALIZADO

**Data:** 04/06/2025  
**Status:** PROBLEMA IDENTIFICADO

### Situa√ß√£o Atual:

- **Tenant Ativo:** `83d6df9e-eec5-4d37-be60-97bf712d85ab`
- **Usu√°rio:** `jrcarlosmachado@gmail.com` (tipo: user)
- **Tenants Dispon√≠veis:**
  - `83d6df9e-eec5-4d37-be60-97bf712d85ab` ‚úÖ (atual)
  - `cdbba3b9-3344-40cd-9f2d-5a463efc272d` ‚ùå (sem subscriptions)

### ‚ùå Problema Identificado:

O grupo `93ae7ed7-8077-4ed4-9947-ca3e991a253f` **N√ÉO EXISTE** no tenant atual.

```bash
# Erro retornado:
Resource '93ae7ed7-8077-4ed4-9947-ca3e991a253f' does not exist or one of its queried reference-property objects are not present.
```

## üîß SOLU√á√ïES IMEDIATAS

### Solu√ß√£o A: Criar Novo Grupo no Tenant Atual

```bash
# 1. Criar novo grupo Entra ID
az ad group create \
  --display-name "AKS-DroneDelivery-Admins" \
  --mail-nickname "aks-drone-admins" \
  --description "Grupo para administradores do cluster AKS Drone Delivery"

# 2. Obter o ID do grupo criado
GROUP_ID=$(az ad group show --group "AKS-DroneDelivery-Admins" --query "id" -o tsv)
echo "Novo Group ID: $GROUP_ID"

# 3. Adicionar usu√°rio atual ao grupo
USER_ID=$(az ad signed-in-user show --query "id" -o tsv)
az ad group member add --group "$GROUP_ID" --member-id "$USER_ID"
```

### Solu√ß√£o B: Usar Usu√°rio Espec√≠fico em vez de Grupo

Se n√£o quiser criar um grupo, pode usar o Object ID do usu√°rio diretamente:

```bash
# Obter Object ID do usu√°rio atual
USER_ID=$(az ad signed-in-user show --query "id" -o tsv)
echo "User Object ID: $USER_ID"
```

## üìù ATUALIZA√á√ÉO DOS ARQUIVOS

### 1. Atualizar RBAC (Op√ß√£o A - Novo Grupo)

Ap√≥s criar o novo grupo, atualize o arquivo RBAC:

```yaml
# cluster-manifests/user-facing-cluster-role-entra-group.yaml
subjects:
  - kind: Group
    name: <NOVO_GROUP_ID> # Substitua pelo ID do grupo criado
```

### 2. Atualizar RBAC (Op√ß√£o B - Usu√°rio Direto)

Para usar usu√°rio espec√≠fico:

```yaml
# cluster-manifests/user-facing-cluster-role-entra-group.yaml
subjects:
  - kind: User
    name: <USER_OBJECT_ID> # Substitua pelo Object ID do usu√°rio
    apiGroup: rbac.authorization.k8s.io
```

### 3. Atualizar Par√¢metros de Deploy

Atualize o arquivo `azuredeploy.parameters.prod.json`:

```json
{
  "k8sRbacEntraAdminGroupObjectID": {
    "value": "<NOVO_GROUP_ID_OU_USER_ID>"
  },
  "k8sRbacEntraProfileTenantId": {
    "value": "83d6df9e-eec5-4d37-be60-97bf712d85ab"
  }
}
```

## Solu√ß√£o para Erro AADSTS500208 - Entra ID External com AKS

## Problema Identificado

O erro AADSTS500208 ("The domain '[domain]' is not a valid login domain name for this tenant type") ocorre ao tentar usar `az login` com uma conta de Entra ID External que n√£o est√° corretamente configurada no tenant.

## Diagn√≥stico do Problema

### 1. Verificar Configura√ß√£o Atual

O arquivo `user-facing-cluster-role-entra-group.yaml` est√° configurado com o grupo ID:

```yaml
subjects:
  - kind: Group
    name: 93ae7ed7-8077-4ed4-9947-ca3e991a253f
```

### 2. Verificar Par√¢metros do Deployment

No arquivo `azuredeploy.parameters.prod.json`:

- `k8sRbacEntraAdminGroupObjectID`: Deve corresponder ao grupo configurado
- `k8sRbacEntraProfileTenantId`: Deve ser o tenant correto

## Solu√ß√µes Poss√≠veis

### Solu√ß√£o 1: Login com Tenant Espec√≠fico

Em vez de usar `az login` simples, use:

```bash
# Para Entra ID External, especifique o tenant explicitamente
az login --tenant <TENANT_ID>

# Ou use o dom√≠nio do tenant
az login --tenant <TENANT_DOMAIN>

# Para usu√°rios convidados (guest), use:
az login --tenant <HOST_TENANT_ID>
```

### Solu√ß√£o 2: Verificar e Corrigir Configura√ß√£o do Grupo

1. Verificar se o grupo existe no tenant correto:

```bash
az ad group show --group 93ae7ed7-8077-4ed4-9947-ca3e991a253f
```

2. Verificar membros do grupo:

```bash
az ad group member list --group 93ae7ed7-8077-4ed4-9947-ca3e991a253f
```

### Solu√ß√£o 3: Reconfigurar RBAC para Usu√°rio Espec√≠fico

Se necess√°rio, pode-se adicionar RBAC para usu√°rio espec√≠fico em vez de grupo:

```yaml
subjects:
  - kind: User
    name: <USER_OBJECT_ID>
    apiGroup: rbac.authorization.k8s.io
```

### Solu√ß√£o 4: Login Interativo com Device Code

Para ambientes com restri√ß√µes de autentica√ß√£o:

```bash
az login --use-device-code --tenant <TENANT_ID>
```

## Passos para Resolu√ß√£o

### Passo 1: Identificar o Tenant Correto

```bash
# Listar todos os tenants dispon√≠veis
az account tenant list

# Verificar o tenant atual
az account show --query "tenantId" -o tsv
```

### Passo 2: Login com Tenant Espec√≠fico

```bash
# Substitua TENANT_ID pelo ID do tenant correto
az login --tenant TENANT_ID
```

### Passo 3: Verificar Acesso ao AKS

```bash
# Obter credenciais do AKS
az aks get-credentials --resource-group <RESOURCE_GROUP> --name <AKS_CLUSTER_NAME>

# Testar acesso
kubectl get nodes
```

### Passo 4: Verificar RBAC

```bash
# Verificar se o usu√°rio tem acesso
kubectl auth can-i get nodes

# Verificar grupos do usu√°rio atual
kubectl auth whoami
```

## Valida√ß√£o Final

### Verificar se o problema foi resolvido:

1. Login bem-sucedido com `az login --tenant <TENANT_ID>`
2. Acesso ao cluster AKS com `kubectl get nodes`
3. Permiss√µes RBAC funcionando corretamente

### Logs para Diagn√≥stico:

```bash
# Verificar logs de autentica√ß√£o
az account get-access-token --resource https://management.azure.com/ --query accessToken -o tsv | base64 -d
```

## Melhores Pr√°ticas para Entra ID External

1. **Sempre especificar o tenant** ao fazer login
2. **Usar grupos em vez de usu√°rios** para facilitar gerenciamento
3. **Implementar princ√≠pio de menor privil√©gio** no RBAC
4. **Monitorar logs de autentica√ß√£o** regularmente
5. **Manter documenta√ß√£o** de usu√°rios e grupos configurados

## Troubleshooting Adicional

Se o problema persistir:

1. Verificar se o usu√°rio est√° corretamente adicionado ao tenant
2. Confirmar se o grupo est√° no tenant correto
3. Verificar pol√≠ticas de acesso condicional
4. Contatar administrador do Entra ID External
