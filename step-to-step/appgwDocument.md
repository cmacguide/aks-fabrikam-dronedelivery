# Documenta√ß√£o das Corre√ß√µes - Application Gateway SSL Certificate

_Generated by Copilot_

Este documento detalha as modifica√ß√µes realizadas para corrigir os problemas de deploy do cluster AKS relacionados √† configura√ß√£o de certificados SSL no Application Gateway.

## Problemas Encontrados

### 1. Erro de Senha do Certificado SSL

- **Erro**: `InvalidApplicationGatewaySSLCertificatePassword`
- **Descri√ß√£o**: O Application Gateway estava tentando usar uma senha para um certificado armazenado no Key Vault, mas certificados no Key Vault n√£o devem ter senha quando referenciados pelo Application Gateway.

### 2. Erros de Compila√ß√£o Bicep

- **Erro**: Propriedades `eTag` inv√°lidas em recursos `savedSearches`
- **Erro**: Propriedade `maxAgentPools` somente leitura no cluster AKS

### 3. Problemas de Quota de Recursos

- **Erro**: Excedendo limite de 10 vCPUs na regi√£o
- **Erro**: Tamanho de disco ef√™mero incompat√≠vel com VM Standard_DS2_v2

## Solu√ß√µes Implementadas

### 1. Corre√ß√£o do Certificado SSL

#### a) Remo√ß√£o da Senha do Certificado no Template Bicep

**Arquivo**: `cluster-stamp.bicep`

**Modifica√ß√£o**:

```bicep
// ANTES - configura√ß√£o com senha
sslCertificates: [
  {
    name: 'appGatewaySslCert'
    properties: {
      keyVaultSecretId: keyVaultCertificateUri
      password: sslCertificatePassword  // ‚ùå REMOVIDO
    }
  }
]

// DEPOIS - configura√ß√£o sem senha
sslCertificates: [
  {
    name: 'appGatewaySslCert'
    properties: {
      keyVaultSecretId: keyVaultCertificateUri
      // password removido para certificados do Key Vault
    }
  }
]
```

#### b) Remo√ß√£o do Par√¢metro de Senha

**Arquivo**: `cluster-stamp.bicep`

**Modifica√ß√£o**:

```bicep
// REMOVIDO - par√¢metro de senha n√£o necess√°rio
@secure()
param sslCertificatePassword string = '123456'
```

#### c) Cria√ß√£o de Certificado Sem Senha

**Comando executado**:

```bash
# Convers√£o do certificado PFX para remover a senha
openssl pkcs12 -in appgw.pfx -out temp.pem -nodes -passin pass:123456
openssl pkcs12 -export -in temp.pem -out appgw-final.pfx -passout pass:
```

**Resultado**: Arquivo `appgw-final.pfx` criado sem senha.

### 2. Atualiza√ß√£o do Arquivo de Par√¢metros

**Arquivo**: `azuredeploy.parameters.prod.json`

**Modifica√ß√£o**:

- Atualizado o valor `appGatewayListenerCertificate` com o certificado Base64 sem senha
- Certificado convertido usando: `base64 -w 0 appgw-final.pfx`

### 3. Corre√ß√µes de Compila√ß√£o Bicep

#### a) Remo√ß√£o de Propriedades eTag

**Arquivo**: `cluster-stamp.bicep`

**Modifica√ß√£o**:

```bicep
// ANTES - com eTag inv√°lido
resource securityDefaultLogsQueries 'Microsoft.OperationalInsights/workspaces/savedSearches@2020-08-01' = {
  parent: la
  name: 'DefaultQueriesSecurityK8s'
  properties: {
    // ... outras propriedades
    eTag: '*'  // ‚ùå REMOVIDO
  }
}

// DEPOIS - sem eTag
resource securityDefaultLogsQueries 'Microsoft.OperationalInsights/workspaces/savedSearches@2020-08-01' = {
  parent: la
  name: 'DefaultQueriesSecurityK8s'
  properties: {
    // ... outras propriedades
    // eTag removido
  }
}
```

**Recursos afetados**:

- `securityDefaultLogsQueries`
- `applicationDefaultLogsQueries`
- `networkingDefaultLogsQueries`

#### b) Remo√ß√£o da Propriedade maxAgentPools

**Arquivo**: `cluster-stamp.bicep`

**Modifica√ß√£o**:

```bicep
// ANTES - com propriedade somente leitura
properties: {
  kubernetesVersion: kubernetesVersion
  maxAgentPools: 2  // ‚ùå REMOVIDO - propriedade somente leitura
  // ... outras propriedades
}

// DEPOIS - sem propriedade somente leitura
properties: {
  kubernetesVersion: kubernetesVersion
  // maxAgentPools removido
  // ... outras propriedades
}
```

### 4. Otimiza√ß√£o de Recursos para Quota

#### a) Redu√ß√£o do N√∫mero de N√≥s

**Arquivo**: `cluster-stamp.bicep`

**Modifica√ß√£o**:

```bicep
// ANTES - 5 n√≥s total (15 vCPUs)
// System node pool: 3 n√≥s
// User node pool: 2 n√≥s

// DEPOIS - 3 n√≥s total (6 vCPUs)
// System node pool: 2 n√≥s
// User node pool: 1 n√≥
```

#### b) Ajuste do Tamanho do Disco OS

**Arquivo**: `cluster-stamp.bicep`

**Modifica√ß√£o**:

```bicep
// ANTES - disco muito grande para ef√™mero
osDiskSizeGB: 120

// DEPOIS - tamanho compat√≠vel com Standard_DS2_v2
osDiskSizeGB: 80
```

## Comando de Deploy Final

O comando de deploy da documenta√ß√£o agora funciona corretamente:

```bash
az deployment group create \
  --resource-group rg-shipping-dronedelivery-${LOCATION} \
  --template-file cluster-stamp.bicep \
  --parameters "@azuredeploy.parameters.prod.json"
```

## Valida√ß√£o das Corre√ß√µes

1. ‚úÖ Template Bicep compila sem erros
2. ‚úÖ Certificado SSL configurado corretamente sem senha
3. ‚úÖ Recursos dentro da quota de vCPU (6 de 10 vCPUs utilizados)
4. ‚úÖ Tamanho de disco compat√≠vel com VMs Standard_DS2_v2
5. ‚úÖ Deploy executando sem problemas

## Arquivos Modificados

1. **`cluster-stamp.bicep`**

   - Removida configura√ß√£o de senha do certificado SSL
   - Removido par√¢metro `sslCertificatePassword`
   - Removidas propriedades `eTag` inv√°lidas
   - Removida propriedade `maxAgentPools` somente leitura
   - Ajustados recursos de n√≥s e disco

2. **`azuredeploy.parameters.prod.json`**

   - Atualizado certificado Base64 sem senha

3. **`appgw-final.pfx`** (novo arquivo)
   - Certificado PFX sem senha para uso com Key Vault

## ‚ö†Ô∏è **Certificados N√£o Utilizados na Solu√ß√£o Atual**

Os seguintes arquivos de certificado na raiz do projeto **N√ÉO s√£o mais utilizados** pela solu√ß√£o:

### ‚ùå **Arquivos Obsoletos:**

- `appgw.crt` - Certificado p√∫blico original (n√£o usado)
- `appgw.key` - Chave privada original (n√£o usada)
- `appgw.pfx` - Certificado original com senha (n√£o usado)

### ‚úÖ **Arquivo Atualmente em Uso:**

- `appgw-final.pfx` - Certificado sem senha (usado no `azuredeploy.parameters.prod.json`)

### üßπ **Limpeza Recomendada:**

Para organizar o projeto e evitar confus√£o, recomendamos remover os arquivos obsoletos:

```bash
# Generated by Copilot
# Remover certificados n√£o utilizados da raiz do projeto
rm -f appgw.crt appgw.key appgw.pfx

# Opcional: mover certificados para pasta espec√≠fica
mkdir -p certificates
mv appgw-final.pfx certificates/
mv k8sic.crt certificates/
mv k8sic.key certificates/
```

### üìù **Por que os Certificados Originais N√£o S√£o Usados:**

1. **`appgw.pfx`**: Tinha senha configurada, incompat√≠vel com Key Vault
2. **`appgw.crt` e `appgw.key`**: Foram substitu√≠dos pelo `appgw-final.pfx` sem senha
3. **Template Bicep**: Agora utiliza apenas o certificado Base64 do arquivo de par√¢metros

### üîç **Verifica√ß√£o:**

Para confirmar que os arquivos n√£o s√£o referenciados:

```bash
# Generated by Copilot
# Buscar refer√™ncias aos certificados obsoletos em todos os arquivos
grep -r "appgw\.crt\|appgw\.key\|appgw\.pfx" . --exclude="appgwDocument.md"
# (Deve retornar vazio, confirmando que n√£o s√£o usados)
```

## Considera√ß√µes para Futuras Implanta√ß√µes

1. **Certificados**: Sempre use certificados sem senha quando armazenados no Azure Key Vault para uso com Application Gateway
2. **Quota**: Monitore o uso de vCPU na regi√£o antes do deploy
3. **Discos Ef√™meros**: Verifique compatibilidade de tamanho com o tipo de VM escolhido
4. **Valida√ß√£o**: Execute `az bicep build` antes do deploy para validar o template

## An√°lise de Seguran√ßa: Certificado Base64 em Arquivo de Par√¢metros

### ‚ùå **Problemas de Seguran√ßa da Abordagem Atual**

Manter o certificado em Base64 no arquivo `azuredeploy.parameters.prod.json` **N√ÉO √© uma boa pr√°tica** de seguran√ßa pelas seguintes raz√µes:

1. **Exposi√ß√£o de Credenciais**: O certificado fica exposto em texto plano (Base64) no reposit√≥rio
2. **Controle de Vers√£o**: Certificados sens√≠veis ficam versionados no Git
3. **Acesso N√£o Controlado**: Qualquer pessoa com acesso ao reposit√≥rio pode acessar o certificado
4. **Rota√ß√£o Complexa**: Trocar certificados requer altera√ß√µes no c√≥digo

### ‚úÖ **Melhores Pr√°ticas Recomendadas**

#### **Op√ß√£o 1: Azure Key Vault (Recomendada)**

```bicep
// Generated by Copilot
// Configura√ß√£o segura - certificado no Key Vault
resource keyVault 'Microsoft.KeyVault/vaults@2023-07-01' existing = {
  name: keyVaultName
  scope: resourceGroup(keyVaultResourceGroup)
}

// Application Gateway busca certificado diretamente do Key Vault
resource applicationGateway 'Microsoft.Network/applicationGateways@2023-11-01' = {
  name: appGatewayName
  properties: {
    sslCertificates: [
      {
        name: 'appGatewaySslCert'
        properties: {
          keyVaultSecretId: '${keyVault.properties.vaultUri}secrets/${certificateSecretName}'
        }
      }
    ]
  }
}
```

**Vantagens**:

- Certificado seguro no Key Vault
- Rota√ß√£o autom√°tica poss√≠vel
- Controle de acesso granular
- Auditoria completa de acessos

#### **Op√ß√£o 2: Par√¢metros Seguros no Deploy**

```bash
# Generated by Copilot
# Passar certificado como par√¢metro seguro no momento do deploy
az deployment group create \
  --resource-group rg-shipping-dronedelivery-${LOCATION} \
  --template-file cluster-stamp.bicep \
  --parameters "@azuredeploy.parameters.prod.json" \
  --parameters appGatewayListenerCertificate="$(cat appgw-final.pfx | base64 -w 0)"
```

#### **Op√ß√£o 3: Pipeline CI/CD com Azure DevOps/GitHub Actions**

```yaml
# Generated by Copilot
# GitHub Actions - certificado como secret
- name: Deploy Infrastructure
  run: |
    az deployment group create \
      --resource-group ${{ vars.RESOURCE_GROUP }} \
      --template-file cluster-stamp.bicep \
      --parameters appGatewayListenerCertificate="${{ secrets.SSL_CERTIFICATE_BASE64 }}"
```

### üîß **Implementa√ß√£o Segura Recomendada**

#### **Passo 1: Remover Certificado do Arquivo de Par√¢metros**

```json
{
  "parameters": {
    "appGatewayListenerCertificate": {
      "value": "SER√Å_FORNECIDO_NO_DEPLOY"
    }
  }
}
```

#### **Passo 2: Upload Seguro para Key Vault**

```bash
# Generated by Copilot
# Upload do certificado para Key Vault
az keyvault certificate import \
  --vault-name $KEY_VAULT_NAME \
  --name appgw-ssl-cert \
  --file appgw-final.pfx
```

#### **Passo 3: Configurar Application Gateway para Key Vault**

```bicep
// Generated by Copilot
// Identidade gerenciada para acessar Key Vault
resource appGwIdentity 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: 'id-appgw-keyvault'
  location: location
}

// Permiss√£o para acessar certificados no Key Vault
resource keyVaultAccessPolicy 'Microsoft.KeyVault/vaults/accessPolicies@2023-07-01' = {
  name: 'add'
  parent: keyVault
  properties: {
    accessPolicies: [
      {
        tenantId: tenant().tenantId
        objectId: appGwIdentity.properties.principalId
        permissions: {
          secrets: ['get']
          certificates: ['get']
        }
      }
    ]
  }
}
```

### üìã **Plano de Migra√ß√£o**

1. **Fase 1**: Upload do certificado para Key Vault
2. **Fase 2**: Modificar template Bicep para usar Key Vault
3. **Fase 3**: Remover certificado do arquivo de par√¢metros
4. **Fase 4**: Configurar pipeline CI/CD com secrets seguros
5. **Fase 5**: Implementar rota√ß√£o autom√°tica de certificados

### üö® **A√ß√£o Imediata Recomendada**

```bash
# Generated by Copilot
# 1. Adicionar arquivo ao .gitignore para evitar commits futuros
echo "*.pfx" >> .gitignore
echo "appgw-final.pfx" >> .gitignore

# 2. Remover hist√≥rico do Git (se necess√°rio)
git filter-branch --force --index-filter \
  'git rm --cached --ignore-unmatch azuredeploy.parameters.prod.json' \
  --prune-empty --tag-name-filter cat -- --all
```

## Links √öteis

- [Azure Application Gateway SSL Certificate Configuration](https://docs.microsoft.com/azure/application-gateway/key-vault-certs)
- [Azure Key Vault Integration with Application Gateway](https://docs.microsoft.com/azure/application-gateway/ssl-overview)
- [AKS Node Pool Configuration](https://docs.microsoft.com/azure/aks/use-multiple-node-pools)

# senhaSegura@2
